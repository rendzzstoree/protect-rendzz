#!/bin/bash

REMOTE_PATH="/var/www/pterodactyl/app/Http/Controllers/Admin/UserController.php"
TIMESTAMP=$(date -u +"%Y-%m-%d-%H-%M-%S")
BACKUP_PATH="${REMOTE_PATH}.bak_${TIMESTAMP}"

echo "üîí Memasang SUPER ADVANCED UserController Protection System..."

# Backup file lama jika ada
if [ -f "$REMOTE_PATH" ]; then
    cp "$REMOTE_PATH" "$BACKUP_PATH"
    echo "üì¶ Backup file lama dibuat di $BACKUP_PATH"
fi

mkdir -p "$(dirname "$REMOTE_PATH")"
chmod 755 "$(dirname "$REMOTE_PATH")"

cat > "$REMOTE_PATH" << 'EOF'
<?php

namespace Pterodactyl\Http\Controllers\Admin;

use Illuminate\View\View;
use Illuminate\Http\Request;
use Pterodactyl\Models\User;
use Illuminate\Support\Collection;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\RedirectResponse;
use Prologue\Alerts\AlertsMessageBag;
use Spatie\QueryBuilder\QueryBuilder;
use Illuminate\View\Factory as ViewFactory;
use Pterodactyl\Exceptions\DisplayException;
use Pterodactyl\Http\Controllers\Controller;
use Illuminate\Contracts\Translation\Translator;
use Pterodactyl\Services\Users\UserUpdateService;
use Pterodactyl\Traits\Helpers\AvailableLanguages;
use Pterodactyl\Services\Users\UserCreationService;
use Pterodactyl\Services\Users\UserDeletionService;
use Pterodactyl\Http\Requests\Admin\UserFormRequest;
use Pterodactyl\Http\Requests\Admin\NewUserFormRequest;
use Pterodactyl\Contracts\Repository\UserRepositoryInterface;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Auth;

class UserController extends Controller
{
    use AvailableLanguages;

    /**
     * UserController constructor.
     */
    public function __construct(
        protected AlertsMessageBag $alert,
        protected UserCreationService $creationService,
        protected UserDeletionService $deletionService,
        protected Translator $translator,
        protected UserUpdateService $updateService,
        protected UserRepositoryInterface $repository,
        protected ViewFactory $view
    ) {
    }

    /**
     * Display user index page.
     */
    public function index(Request $request): View
    {
        $users = QueryBuilder::for(
            User::query()->select('users.*')
                ->selectRaw('COUNT(DISTINCT(subusers.id)) as subuser_of_count')
                ->selectRaw('COUNT(DISTINCT(servers.id)) as servers_count')
                ->leftJoin('subusers', 'subusers.user_id', '=', 'users.id')
                ->leftJoin('servers', 'servers.owner_id', '=', 'users.id')
                ->groupBy('users.id')
        )
            ->allowedFilters(['username', 'email', 'uuid'])
            ->allowedSorts(['id', 'uuid'])
            ->paginate(50);

        return $this->view->make('admin.users.index', ['users' => $users]);
    }

    /**
     * Display new user page.
     */
    public function create(): View
    {
        // üîí Cek permission untuk create user
        $currentUser = Auth::user();
        if (!$currentUser || $currentUser->id !== 1) {
            throw new DisplayException("‚õî Anda tidak memiliki izin untuk membuat user baru. Hanya Admin ID 1 yang dapat melakukan ini.");
        }

        return $this->view->make('admin.users.new', [
            'languages' => $this->getAvailableLanguages(true),
        ]);
    }

    /**
     * Display user view page.
     */
    public function view(User $user): View
    {
        $currentUser = Auth::user();
        
        // üîí Jika bukan admin ID 1, hanya bisa lihat profile sendiri
        if ($currentUser->id !== 1 && $currentUser->id !== $user->id) {
            abort(403, 'üö´ Akses ditolak! Anda hanya dapat melihat profile sendiri.');
        }

        return $this->view->make('admin.users.view', [
            'user' => $user,
            'languages' => $this->getAvailableLanguages(true),
        ]);
    }

    /**
     * Delete a user from the system.
     *
     * @throws \Exception
     * @throws \Pterodactyl\Exceptions\DisplayException
     */
    public function delete(Request $request, User $user): RedirectResponse
    {
        $currentUser = Auth::user();
        
        // üîí LOG DETAILED ACCESS ATTEMPT
        Log::warning('DELETE USER ATTEMPT', [
            'attacker_id' => $currentUser->id,
            'attacker_email' => $currentUser->email,
            'target_user_id' => $user->id,
            'target_email' => $user->email,
            'ip_address' => $request->ip(),
            'user_agent' => $request->userAgent(),
            'timestamp' => now()->toDateTimeString()
        ]);

        // üîí STRICT PROTECTION: Hanya admin ID 1 yang bisa delete user
        if ($currentUser->id !== 1) {
            // üö® Enhanced error message with security logging
            throw new DisplayException(
                "üö® **SECURITY BREACH DETECTED**\n\n" .
                "‚õî **ACCESS DENIED - UNAUTHORIZED DELETE ATTEMPT**\n" .
                "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n" .
                "üìã **Incident Details:**\n" .
                "   ‚Ä¢ Attacker: {$currentUser->email} (ID: {$currentUser->id})\n" .
                "   ‚Ä¢ Target: {$user->email} (ID: {$user->id})\n" .
                "   ‚Ä¢ IP Address: {$request->ip()}\n" .
                "   ‚Ä¢ Time: " . now()->format('Y-m-d H:i:s') . "\n" .
                "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n" .
                "üîí **Security System:** RENDZZ SUPER PROTECT v3.0\n" .
                "üìû **Action Required:** This incident has been logged.\n" .
                "‚ö†Ô∏è  **Note:** Only ROOT ADMIN (ID: 1) can delete users.\n" .
                "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            );
        }

        // üîí Prevent self-deletion
        if ($currentUser->id === $user->id) {
            throw new DisplayException($this->translator->get('admin/user.exceptions.user_has_servers'));
        }

        $this->deletionService->handle($user);

        // ‚úÖ Log successful deletion by admin
        Log::info('USER DELETED BY ADMIN', [
            'admin_id' => $currentUser->id,
            'admin_email' => $currentUser->email,
            'deleted_user_id' => $user->id,
            'deleted_email' => $user->email,
            'timestamp' => now()->toDateTimeString()
        ]);

        $this->alert->success($this->translator->get('admin/user.notices.user_deleted'))->flash();

        return redirect()->route('admin.users');
    }

    /**
     * Create a user.
     *
     * @throws \Exception
     * @throws \Throwable
     */
    public function store(NewUserFormRequest $request): RedirectResponse
    {
        $currentUser = Auth::user();
        
        // üîí Hanya admin ID 1 yang bisa create user
        if ($currentUser->id !== 1) {
            throw new DisplayException(
                "‚õî **CREATE USER PERMISSION DENIED**\n\n" .
                "Hanya Root Administrator (ID: 1) yang dapat membuat user baru.\n" .
                "User yang mencoba: {$currentUser->email}\n" .
                "Waktu: " . now()->format('Y-m-d H:i:s')
            );
        }

        $user = $this->creationService->handle($request->normalize());
        
        // Log creation
        Log::info('USER CREATED BY ADMIN', [
            'admin_id' => $currentUser->id,
            'new_user_id' => $user->id,
            'new_user_email' => $user->email,
            'timestamp' => now()->toDateTimeString()
        ]);

        $this->alert->success($this->translator->get('admin/user.notices.account_created'))->flash();

        return redirect()->route('admin.users.view', $user->id);
    }

    /**
     * Update a user on the system.
     *
     * @throws \Pterodactyl\Exceptions\Model\DataValidationException
     * @throws \Pterodactyl\Exceptions\Repository\RecordNotFoundException
     */
    public function update(UserFormRequest $request, User $user): RedirectResponse
    {
        $currentUser = Auth::user();
        $changes = [];
        
        // üîí DETECT CHANGES FOR LOGGING
        $originalData = $user->toArray();
        
        // üîí SUPER STRICT PERMISSION CHECK
        if ($currentUser->id !== 1) {
            // Jika bukan admin ID 1, hanya boleh edit diri sendiri
            if ($currentUser->id !== $user->id) {
                // üö® Enhanced security logging
                Log::critical('UNAUTHORIZED USER UPDATE ATTEMPT', [
                    'attacker_id' => $currentUser->id,
                    'attacker_email' => $currentUser->email,
                    'target_user_id' => $user->id,
                    'target_email' => $user->email,
                    'request_data' => $request->except(['_token', 'password']),
                    'ip_address' => $request->ip(),
                    'user_agent' => $request->userAgent(),
                    'timestamp' => now()->toDateTimeString()
                ]);

                throw new DisplayException(
                    "üö® **SECURITY ALERT - UNAUTHORIZED MODIFICATION**\n\n" .
                    "‚õî **ACCESS VIOLATION DETECTED**\n" .
                    "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n" .
                    "üìã **Security Incident Report:**\n" .
                    "   ‚Ä¢ Attacker: {$currentUser->email}\n" .
                    "   ‚Ä¢ Target User: {$user->email}\n" .
                    "   ‚Ä¢ Attempted Action: Modify user data\n" .
                    "   ‚Ä¢ IP Address: {$request->ip()}\n" .
                    "   ‚Ä¢ Time: " . now()->format('Y-m-d H:i:s') . "\n" .
                    "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n" .
                    "üîí **Security Policy:**\n" .
                    "   ‚Ä¢ Users can only edit their OWN profile\n" .
                    "   ‚Ä¢ Only ROOT ADMIN can edit other users\n" .
                    "   ‚Ä¢ All violations are logged and monitored\n" .
                    "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n" .
                    "‚ö†Ô∏è  **This incident has been recorded in security logs.**\n" .
                    "üìû **Contact:** System Administrator if this was a mistake.\n" .
                    "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
                );
            }
            
            // üîí Jika edit diri sendiri, cek field yang diubah
            $restrictedFields = ['email', 'root_admin', 'role', 'permissions'];
            foreach ($restrictedFields as $field) {
                if ($request->has($field) && $originalData[$field] != $request->input($field)) {
                    throw new DisplayException(
                        "‚õî **FIELD RESTRICTION VIOLATION**\n\n" .
                        "Field '{$field}' tidak dapat diubah oleh user biasa.\n" .
                        "Hanya Administrator yang dapat mengubah field ini.\n" .
                        "Silahkan kontak administrator sistem."
                    );
                }
            }
        }

        // üîí SPECIAL PROTECTION FOR ADMIN DEMOTION
        if ($user->root_admin && $currentUser->id !== 1) {
            throw new DisplayException(
                "üîê **ADMIN PROTECTION ACTIVE**\n\n" .
                "Tidak dapat menurunkan hak administrator user ini.\n" .
                "Hanya ROOT ADMIN (ID: 1) yang memiliki izin untuk ini.\n" .
                "Sistem keamanan: RENDZZ ADMIN PROTECT v2.0"
            );
        }

        // üîí PREVENT ROOT ADMIN (ID: 1) FROM BEING DEMOTED
        if ($user->id === 1 && $request->has('root_admin') && !$request->input('root_admin')) {
            throw new DisplayException(
                "üëë **ROOT ADMIN PROTECTION**\n\n" .
                "User ID 1 adalah ROOT ADMIN utama sistem.\n" .
                "Status administrator tidak dapat dinonaktifkan.\n" .
                "Ini adalah pengaturan keamanan sistem."
            );
        }

        // üîí EXECUTE UPDATE
        $updatedUser = $this->updateService
            ->setUserLevel(User::USER_LEVEL_ADMIN)
            ->handle($user, $request->normalize());

        // üîí LOG THE UPDATE
        $newData = $updatedUser->toArray();
        foreach ($originalData as $key => $value) {
            if (isset($newData[$key]) && $newData[$key] != $value) {
                $changes[$key] = [
                    'from' => $value,
                    'to' => $newData[$key]
                ];
            }
        }

        if (!empty($changes)) {
            Log::info('USER DATA UPDATED', [
                'updater_id' => $currentUser->id,
                'updater_email' => $currentUser->email,
                'target_user_id' => $user->id,
                'target_email' => $user->email,
                'changes' => $changes,
                'ip_address' => $request->ip(),
                'timestamp' => now()->toDateTimeString()
            ]);
        }

        $this->alert->success(trans('admin/user.notices.account_updated'))->flash();

        return redirect()->route('admin.users.view', $user->id);
    }

    /**
     * Get a JSON response of users on the system.
     */
    public function json(Request $request): JsonResponse
    {
        $currentUser = Auth::user();
        
        // üîí Hanya admin yang bisa akses JSON data users
        if (!$currentUser->root_admin) {
            return response()->json([
                'error' => 'Unauthorized',
                'message' => '‚õî Hanya administrator yang dapat mengakses data JSON users.',
                'security_level' => 'high',
                'system' => 'RENDZZ SECURITY v3.0'
            ], 403);
        }

        $users = QueryBuilder::for(User::query())->allowedFilters(['email'])->paginate(25);

        // Handle single user requests.
        if ($request->query('user_id')) {
            $user = User::query()->findOrFail($request->input('user_id'));
            $user->md5 = md5(strtolower($user->email));

            return response()->json($user);
        }

        $users->transform(function ($item) {
            $item->md5 = md5(strtolower($item->email));
            return $item;
        });

        return response()->json($users);
    }
}
EOF

# Set permissions
chmod 644 "$REMOTE_PATH"
chown www-data:www-data "$REMOTE_PATH"

# Clear Laravel cache
cd /var/www/pterodactyl 2>/dev/null && php artisan view:clear > /dev/null 2>&1

echo ""
echo "‚úÖ SUPER ADVANCED UserController Protection installed!"
echo ""
echo "üîí FEATURES ENABLED:"
echo "   1. Only Admin ID 1 can delete users"
echo "   2. Users can only edit their OWN profile"
echo "   3. Root Admin (ID 1) cannot be demoted"
echo "   4. Detailed security logging for all actions"
echo "   5. JSON API protection"
echo "   6. Field-level permission controls"
echo "   7. IP address tracking"
echo "   8. User agent logging"
echo ""
echo "üìÅ Backup file: $BACKUP_PATH"
echo "üéØ Security System: RENDZZ SUPER PROTECT v3.0"
echo "‚ö†Ô∏è  All unauthorized attempts will be logged!"
echo ""
