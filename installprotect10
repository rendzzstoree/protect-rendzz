#!/bin/bash

echo "ðŸŽ¨ Installing iOS Dark Theme with Greeting Message..."

PANEL_PATH="/var/www/pterodactyl"
BASE_TEMPLATE="$PANEL_PATH/resources/views/templates/base/core.blade.php"
AUTH_LAYOUT="$PANEL_PATH/resources/views/layouts/auth.blade.php"
APP_LAYOUT="$PANEL_PATH/resources/views/layouts/app.blade.php"
TIMESTAMP=$(date -u +"%Y-%m-%d-%H-%M-%S")

# ===== BACKUP =====
cp "$BASE_TEMPLATE" "${BASE_TEMPLATE}.bak_${TIMESTAMP}"
cp "$AUTH_LAYOUT" "${AUTH_LAYOUT}.bak_${TIMESTAMP}"
cp "$APP_LAYOUT" "${APP_LAYOUT}.bak_${TIMESTAMP}"
echo "ðŸ“¦ Backup semua file OK"

# ===== 1. UPDATE BASE TEMPLATE (GREETING MESSAGE) =====
cat > "$BASE_TEMPLATE" << 'EOF'
@extends('templates/wrapper', [
    'css' => ['body' => 'bg-neutral-800'],
])

@section('container')
    <div id="modal-portal"></div>
    <div id="app"></div>

    <!-- iOS Theme CSS -->
    <style>
    /* ===== iOS DARK THEME - RENSTR EDITION ===== */
    :root {
      --ios-bg: #000000;
      --ios-card: #1c1c1e;
      --ios-card-secondary: #2c2c2e;
      --ios-surface: #3a3a3c;
      --ios-blue: #0a84ff;
      --ios-blue-light: #5ac8fa;
      --ios-green: #30d158;
      --ios-red: #ff375f;
      --ios-purple: #bf5af2;
      --ios-text-primary: #ffffff;
      --ios-text-secondary: #8e8e93;
      --ios-text-tertiary: #636366;
      --ios-border: #38383a;
      --ios-blur: rgba(28,28,30,0.65);
      --ios-shadow: 0 8px 32px rgba(0,0,0,0.28);
    }

    /* iOS Theme Global Styles */
    body {
      background: var(--ios-bg) !important;
      color: var(--ios-text-primary) !important;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Inter", sans-serif !important;
      margin: 0;
      padding: 0;
    }

    /* iOS Cards */
    .bg-white, .bg-gray-100, .card, .panel {
      background: var(--ios-card) !important;
      border: 1px solid var(--ios-border) !important;
      border-radius: 18px !important;
      color: var(--ios-text-primary) !important;
      box-shadow: var(--ios-shadow) !important;
      margin-bottom: 1rem !important;
      transition: all 0.3s ease !important;
    }

    /* iOS Buttons */
    button, .btn, [type="submit"] {
      background: var(--ios-blue) !important;
      color: white !important;
      border: none !important;
      border-radius: 12px !important;
      padding: 14px 24px !important;
      font-size: 17px !important;
      font-weight: 600 !important;
      cursor: pointer !important;
      transition: all 0.2s ease !important;
    }

    button:hover, .btn:hover {
      background: #007aff !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 8px 24px rgba(10, 132, 255, 0.3) !important;
    }

    /* iOS Inputs */
    input, select, textarea {
      background: var(--ios-card-secondary) !important;
      border: 1px solid var(--ios-border) !important;
      border-radius: 12px !important;
      color: var(--ios-text-primary) !important;
      padding: 12px 16px !important;
      font-size: 17px !important;
    }

    /* Header iOS */
    .bg-gray-800 {
      background: var(--ios-blur) !important;
      backdrop-filter: blur(20px) !important;
      border-bottom: 1px solid var(--ios-border) !important;
    }

    /* Status Colors */
    .bg-success { background: var(--ios-green) !important; }
    .bg-danger { background: var(--ios-red) !important; }
    .bg-primary { background: var(--ios-blue) !important; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--ios-card); border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: var(--ios-surface); border-radius: 4px; }

    /* Footer Custom */
    .text-center.text-xs.text-gray-500::after {
      content: "RENSTR â€¢ iOS Dark Theme";
      color: var(--ios-text-tertiary) !important;
      font-size: 13px !important;
    }
    </style>

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const username = @json(auth()->user()->name?? 'User');
        
        // Create iOS-style greeting message
        const message = document.createElement("div");
        message.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-moon" style="color: #0a84ff; font-size: 16px;"></i>
            <span>Halo, <strong>${username}</strong>! ðŸ‘‹</span>
          </div>
          <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">
            Welcome to iOS Dark Theme
          </div>
        `;
        
        Object.assign(message.style, {
          position: "fixed",
          bottom: "20px",
          right: "20px",
          background: "var(--ios-card, rgba(28,28,30,0.9))",
          color: "var(--ios-text-primary, #ffffff)",
          padding: "15px 20px",
          borderRadius: "16px",
          fontFamily: "-apple-system, BlinkMacSystemFont, sans-serif",
          fontSize: "14px",
          boxShadow: "0 8px 32px rgba(0,0,0,0.28)",
          border: "1px solid var(--ios-border, #38383a)",
          backdropFilter: "blur(20px)",
          zIndex: "99999",
          opacity: "1",
          transition: "all 0.5s cubic-bezier(0.4, 0, 0.2, 1)",
          maxWidth: "300px",
          transform: "translateY(0)"
        });

        document.body.appendChild(message);
        
        // Auto-hide after 4 seconds
        setTimeout(() => {
          message.style.transform = "translateY(100px)";
          message.style.opacity = "0";
        }, 4000);
        
        setTimeout(() => {
          if (message.parentNode) {
            message.remove();
          }
        }, 5000);

        // Add click to dismiss
        message.addEventListener("click", () => {
          message.style.transform = "translateY(100px)";
          message.style.opacity = "0";
          setTimeout(() => message.remove(), 500);
        });
      });
    </script>
@endsection
EOF

echo "âœ… Base template updated with iOS theme"

# ===== 2. UPDATE AUTH LAYOUT (LOGIN PAGE) =====
AUTH_CSS='<style>
/* Login Page Specific iOS Styles */
#app > div {
  background: linear-gradient(135deg, #000000 0%, #1a1a1a 50%, #2d2d2d 100%) !important;
  position: relative;
  overflow: hidden;
}

#app > div::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: 
    radial-gradient(circle at 20% 80%, rgba(10, 132, 255, 0.08) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(191, 90, 242, 0.08) 0%, transparent 50%);
  pointer-events: none;
}

/* Login Card Enhancement */
.bg-white, .bg-gray-100 {
  background: rgba(28, 28, 30, 0.85) !important;
  backdrop-filter: blur(30px) !important;
  -webkit-backdrop-filter: blur(30px) !important;
}

/* Login Title */
.text-2xl, .text-3xl {
  background: linear-gradient(90deg, #0a84ff, #5ac8fa) !important;
  -webkit-background-clip: text !important;
  -webkit-text-fill-color: transparent !important;
  font-weight: 700 !important;
}
</style>'

sed -i "/<\/head>/i $AUTH_CSS" "$AUTH_LAYOUT"

# ===== 3. ADD FONT TO ALL PAGES =====
FONT_LINK='<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">'

sed -i "/<\/head>/i $FONT_LINK" "$AUTH_LAYOUT"
sed -i "/<\/head>/i $FONT_LINK" "$APP_LAYOUT"

# ===== 4. PERMISSIONS =====
chown -R www-data:www-data "$PANEL_PATH"

# ===== 5. CLEAR CACHE =====
cd "$PANEL_PATH" || exit
php artisan view:clear
php artisan cache:clear
php artisan config:clear

echo "========================================="
echo "ðŸŽ‰ iOS DARK THEME + GREETING INSTALLED!"
echo "========================================="
echo "âœ¨ Features included:"
echo "â€¢ Full iOS Dark Mode design"
â€¢ Greeting message with user name
â€¢ Glassmorphism effects
â€¢ Smooth animations
â€¢ Custom status colors
â€¢ Font Awesome icons
â€¢ Auto-dismiss notification
â€¢ Click-to-dismiss functionality
echo "========================================="
